name: CD

on:
  push:
    branches:
      - main  # Run on pushes to main branch
  workflow_dispatch:  # Allow manual trigger

jobs:
  version:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to create tags and push to repository
    outputs:
      new_tag: ${{ steps.bump_version.outputs.new_tag }}
      changelog: ${{ steps.bump_version.outputs.changelog }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for proper version detection

    - name: Bump version and create tag
      id: bump_version
      uses: mathieudutour/github-tag-action@v6.2
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        default_bump: patch
        release_branches: main
        create_annotated_tag: true

  build:
    needs: version
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for proper version detection
        ref: ${{ needs.version.outputs.new_tag }}

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24.0'

    - name: Verify Go installation
      run: go version

    - name: Install dependencies
      run: go mod download

    - name: Build for Windows (amd64)
      run: GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o gospidertrap_windows_amd64.exe

    - name: Build for macOS (amd64)
      run: GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o gospidertrap_darwin_amd64

    - name: Build for macOS (arm64)
      run: GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o gospidertrap_darwin_arm64

    - name: Build for Linux (amd64)
      run: GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o gospidertrap_linux_amd64

    - name: Build for Linux (arm64)
      run: GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o gospidertrap_linux_arm64

    - name: Archive builds
      uses: actions/upload-artifact@v4
      with:
        name: gospidertrap-builds
        path: |
          gospidertrap_windows_amd64.exe
          gospidertrap_darwin_amd64
          gospidertrap_darwin_arm64
          gospidertrap_linux_amd64
          gospidertrap_linux_arm64

  release:
    needs: [version, build]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ needs.version.outputs.new_tag }}

    - name: Download builds
      uses: actions/download-artifact@v4
      with:
        name: gospidertrap-builds
        path: ./builds

    - name: Create release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ needs.version.outputs.new_tag }}
        name: Release ${{ needs.version.outputs.new_tag }}
        body: |
          ## gospidertrap ${{ needs.version.outputs.new_tag }}

          ### Changes
          ${{ needs.version.outputs.changelog }}

          ### Downloads
          Choose the appropriate binary for your platform:

          - **Linux (amd64)**: `gospidertrap_linux_amd64`
          - **Linux (arm64)**: `gospidertrap_linux_arm64`
          - **macOS (Intel)**: `gospidertrap_darwin_amd64`
          - **macOS (Apple Silicon)**: `gospidertrap_darwin_arm64`
          - **Windows (amd64)**: `gospidertrap_windows_amd64.exe`

          ### Installation

          ```bash
          # Linux/macOS
          chmod +x gospidertrap_*
          ./gospidertrap_* -p 8000

          # Windows
          gospidertrap_windows_amd64.exe -p 8000
          ```

          See [README.md](https://github.com/${{ github.repository }}) for usage instructions.
        draft: false
        prerelease: false
        files: |
          builds/gospidertrap_windows_amd64.exe
          builds/gospidertrap_darwin_amd64
          builds/gospidertrap_darwin_arm64
          builds/gospidertrap_linux_amd64
          builds/gospidertrap_linux_arm64
