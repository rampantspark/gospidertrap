name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Only run on version tags (e.g., v1.0.0, v1.2.3)
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for proper version detection

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24.0'

    - name: Verify Go installation
      run: go version

    - name: Install dependencies
      run: go mod download

    - name: Build for Windows (amd64)
      run: GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o gospidertrap_windows_amd64.exe

    - name: Build for macOS (amd64)
      run: GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o gospidertrap_darwin_amd64

    - name: Build for macOS (arm64)
      run: GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o gospidertrap_darwin_arm64

    - name: Build for Linux (amd64)
      run: GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o gospidertrap_linux_amd64

    - name: Build for Linux (arm64)
      run: GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o gospidertrap_linux_arm64

    - name: Archive builds
      uses: actions/upload-artifact@v4
      with:
        name: gospidertrap-builds
        path: |
          gospidertrap_windows_amd64.exe
          gospidertrap_darwin_amd64
          gospidertrap_darwin_arm64
          gospidertrap_linux_amd64
          gospidertrap_linux_arm64

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')  # Only create release for tags

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download builds
      uses: actions/download-artifact@v4
      with:
        name: gospidertrap-builds
        path: ./builds

    - name: Get tag name
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: Release ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## gospidertrap ${{ steps.get_version.outputs.VERSION }}

          ### Downloads
          Choose the appropriate binary for your platform:

          - **Linux (amd64)**: `gospidertrap_linux_amd64`
          - **Linux (arm64)**: `gospidertrap_linux_arm64`
          - **macOS (Intel)**: `gospidertrap_darwin_amd64`
          - **macOS (Apple Silicon)**: `gospidertrap_darwin_arm64`
          - **Windows (amd64)**: `gospidertrap_windows_amd64.exe`

          ### Installation

          ```bash
          # Linux/macOS
          chmod +x gospidertrap_*
          ./gospidertrap_* -p 8000

          # Windows
          gospidertrap_windows_amd64.exe -p 8000
          ```

          See [README.md](https://github.com/${{ github.repository }}) for usage instructions.
        draft: false
        prerelease: false
        files: |
          builds/gospidertrap_windows_amd64.exe
          builds/gospidertrap_darwin_amd64
          builds/gospidertrap_darwin_arm64
          builds/gospidertrap_linux_amd64
          builds/gospidertrap_linux_arm64
